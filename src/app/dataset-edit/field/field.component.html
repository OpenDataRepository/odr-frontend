<!-- TODO: Resolve this next. This is more complicated now, since plugins exist on the template, not on the field.
Even if the user doesn't have edit access to the field, they can still edit plugins if they have edit access to the template. -->

<!-- This is the preview of how it will will on the record, and the default of how it appears unless the user selects edit -->
<div [ngClass]="{'gray-border': !may_edit, 'normal-border-2': may_edit && form.valid, 'invalid-border': may_edit && !form.valid}">
  <ion-item>
    <ion-label>
      <p><span style="color: blue;">{{ name?.value }} ({{ uuid?.value }})</span></p>
      <p>Value Preview...</p>
    </ion-label>
    <div slot="end" *ngIf="!disabled" style="display: grid;">
      <ion-button [attr.id]="'edit-field-' + template_uuid + '-' + uuid?.value" [disabled]="!may_edit">Edit Field</ion-button>
      <ion-button (click)="remove.emit()" color="danger">Remove Field</ion-button>
    </div>
  </ion-item>
</div>

<!-- This is the edit modal -->
<ion-modal *ngIf="!disabled" #edit_field_modal [attr.trigger]="'edit-field-' + template_uuid + '-' + uuid?.value">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Edit Field</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding">
      <div [ngClass]="{'gray-border': !may_edit, 'normal-border-2': may_edit && form.valid, 'invalid-border': may_edit && !form.valid}">
        <form [formGroup]="form">

          <ion-item lines="inset">
            <ion-label>uuid: {{ uuid?.value }}</ion-label>
            <ion-button *ngIf="public_date" slot="end" color="success" (click)="makePrivate()" [disabled]="!may_edit">Public</ion-button>
            <ion-button *ngIf="!public_date" slot="end" color="danger" (click)="makePublic()" [disabled]="!may_edit">Private</ion-button>
          </ion-item>
          <!-- TODO: I don't remember this logic. shouldn't this just be updated_at? If you have permission to updated_at you can view -->
          <div *ngIf="!uuid || public_date || updated_at">

            <ion-item lines="inset" [style.--highlight-height]="may_edit ? '2px' : '0px'">
              <ion-input
                label="Name:"
                formControlName="name"
                [placeholder]="may_edit ? 'Enter name here...' : ''"
                [readonly]="!may_edit"
                errorText="Name is required">
              </ion-input>
            </ion-item>

            <ion-item lines="inset" [style.--highlight-height]="may_edit ? '2px' : '0px'">
              <ion-input
                label="Description:"
                formControlName="description"
                [placeholder]="may_edit ? 'Enter description here...' : ''"
                [readonly]="!may_edit">
              </ion-input>
            </ion-item>

            <div *ngIf="may_edit">
              <ion-item lines="inset">
                <ion-select label="Field Type" formControlName="type" value="none">
                  <ion-select-option value="none">None (text)</ion-select-option>
                  <ion-select-option value="File">File</ion-select-option>
                </ion-select>
              </ion-item>
            </div>
            <ion-item *ngIf="!may_edit" lines="none">Field Type: {{ type.value }}</ion-item>

            <div *ngIf="!!uuid">
              <ion-item lines="none">Plugins: </ion-item>
              <div *ngFor="let plugin_name of current_plugin_keys"
                class="ion-margin"
                [ngClass]="{'gray-border': !may_edit, 'normal-border': may_edit}"
              >
                <ion-item><ion-label>Name: {{plugin_name}}</ion-label></ion-item>
                <ion-item lines="inset">
                  <ion-select
                    label="Version: "
                    (ionChange)="changePluginVersion(plugin_name, $event)"
                    [value]="getExistingPluginVersionOrLatest(plugin_name)"
                  >
                    <ion-select-option *ngFor="let version of all_field_plugins[plugin_name]" [value]="version">v{{version}}</ion-select-option>
                  </ion-select>
                </ion-item>
                <div *ngIf="getPluginOptions(plugin_name)">
                  <ion-item lines="inset">
                    <ion-label>Plugin options:</ion-label>
                  </ion-item>
                  <ion-list class="ion-margin">
                    <ion-item lines="inset" *ngFor="let plugin_option_name of getPluginOptionKeys(plugin_name)" [detail]="false">
                      <ion-label>{{ plugin_option_name }}</ion-label>
                      <ion-select
                        (ionChange)="changePluginOption(plugin_name, plugin_option_name, $event)"
                        [value]="getExistingPluginOption(plugin_name, plugin_option_name)"
                      >
                        <ion-select-option *ngFor="let option of safeGetPluginOptions(plugin_name)[plugin_option_name]" [value]="option">{{option}}</ion-select-option>
                      </ion-select>
                    </ion-item>
                  </ion-list>
                </div>
                <ion-item><ion-button color="danger" (click)="removePlugin(plugin_name)">Remove Plugin</ion-button></ion-item>
              </div>
              <div *ngIf="may_edit && !!uuid">
                <ion-item lines="none">
                  <ion-button [attr.id]="'add-plugin-' + template_uuid + '-' + uuid?.value">Add Plugin</ion-button>
                </ion-item>
                <ion-modal #add_plugin_modal [attr.trigger]="'add-plugin-' + template_uuid + '-' + uuid?.value">
                  <ng-template>
                    <ion-header>
                      <ion-toolbar>
                        <ion-buttons slot="start">
                          <ion-button (click)="add_plugin_modal.dismiss()">Cancel</ion-button>
                        </ion-buttons>
                        <ion-title>Select a plugin to add</ion-title>
                      </ion-toolbar>
                    </ion-header>
                    <ion-content class="ion-padding">
                      <div>
                        <ion-item>
                          <ion-label><b>Plugins:</b></ion-label>
                        </ion-item>
                        <ion-list>
                          <ion-item *ngFor="let plugin_name of all_field_plugin_keys" [detail]="false"
                            button (click)="confirmAddPluginModal(plugin_name)"
                          >
                            <ion-label>{{ plugin_name }}</ion-label>
                          </ion-item>
                        </ion-list>
                      </div>
                    </ion-content>
                  </ng-template>
                </ion-modal>
              </div>
            </div>
          </div>
        </form>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
